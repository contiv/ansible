---
# This role contains tasks for configuring and starting netmaster and netplugin service

- name: remove older netmaster
  file: path=/usr/bin/netmaster state=absent

- name: remove older netplugin
  file: path=/usr/bin/netplugin state=absent

- name: remove older compose
  file: path=/usr/bin/docker-compose state=absent

- name: remove older contivctl
  file: path=/usr/bin/contivctl state=absent

- name: remove older tar file
  file: path=/tmp/contivnet.tar.bz2 state=absent

- name: download netmaster and netplugin
  get_url:
    validate_certs: no
    url: https://cisco.box.com/shared/static/hs2gp4jfvssr1bu2geh3o6yipse9ljjd.bz2
    dest: /tmp/contivnet.tar.bz2

- name: install netmaster and netplugin
  shell: tar vxjf /tmp/contivnet.tar.bz2
  args:
    chdir: /usr/bin/
    creates: netmaster

- name: copy environment file for netmaster
  copy: src=netmaster dest=/etc/default/netmaster
  when: run_as == "master"

- name: copy systemd units for netmaster
  copy: src=netmaster.service dest=/etc/systemd/system/netmaster.service
  when: run_as == "master"

- name: restart netmaster
  shell: systemctl daemon-reload && systemctl stop netmaster && systemctl start netmaster
  when: run_as == "master"

- name: copy environment file for netplugin
  template: src=netplugin.j2 dest=/etc/default/netplugin mode=0644

- name: copy systemd units for netplugin
  copy: src=netplugin.service dest=/etc/systemd/system/netplugin.service

- name: restart netplugin
  shell: systemctl daemon-reload && systemctl stop netplugin && systemctl start netplugin

- name: setup netmaster host alias
  shell: echo "{{ service_vip }} netmaster" >> /etc/hosts

# XXX: need to move the following to correct roles
#- name: install contivctl
#  shell: source /etc/profile.d/00golang.sh && go get github.com/contiv/contivctl
#
#- name: install docker-compose
#  shell: pip install docker-compose
#
#- name: install contiv-compose
#  shell: >
#     source /etc/profile.d/00golang.sh && \
#     go get github.com/contiv/libcompose && \
#     cd $GOPATH/src/github.com/contiv/libcompose && \
#     make binary && \
#     ln -s `pwd`/bundles/libcompose-cli_linux-amd64 $GOPATH/bin/contiv-compose
